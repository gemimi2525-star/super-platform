name: Phase Ledger Write ‚Äî Phase 34.3

on:
  # After deploy to production (push to main)
  push:
    branches: [main]
  # Manual trigger (for preview / ad-hoc)
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to snapshot (e.g. Vercel preview URL)'
        required: false
        default: 'https://www.apicoredata.com'
      environment:
        description: 'Environment label'
        required: false
        default: 'production'

jobs:
  write-snapshot:
    name: Write Phase Ledger Snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Wait for Vercel deploy
        if: github.event_name == 'push'
        run: sleep 120  # Wait 2 min for Vercel auto-deploy

      - name: Set target URL
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
            echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "url=https://www.apicoredata.com" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
          fi

      - name: Fetch build-info
        id: build
        run: |
          RESPONSE=$(curl -sf "${{ steps.target.outputs.url }}/api/build-info?cb=$(date +%s)" || echo '{}')
          echo "json=$RESPONSE" >> $GITHUB_OUTPUT
          echo "commit=$(echo $RESPONSE | jq -r '.commit // empty')" >> $GITHUB_OUTPUT
          echo "version=$(echo $RESPONSE | jq -r '.version // empty')" >> $GITHUB_OUTPUT
          echo "sha_resolved=$(echo $RESPONSE | jq -r '.shaResolved // false')" >> $GITHUB_OUTPUT
          echo "branch=$(echo $RESPONSE | jq -r '.branch // empty')" >> $GITHUB_OUTPUT

      - name: Fetch integrity
        id: integrity
        run: |
          RESPONSE=$(curl -sf "${{ steps.target.outputs.url }}/api/platform/integrity?cb=$(date +%s)" || echo '{}')
          echo "json=$RESPONSE" >> $GITHUB_OUTPUT
          echo "status=$(echo $RESPONSE | jq -r '.status // empty')" >> $GITHUB_OUTPUT
          echo "phase=$(echo $RESPONSE | jq -r '.phase // empty')" >> $GITHUB_OUTPUT
          echo "version=$(echo $RESPONSE | jq -r '.version // empty')" >> $GITHUB_OUTPUT
          echo "signature=$(echo $RESPONSE | jq -r '.signature // empty')" >> $GITHUB_OUTPUT
          echo "kernel_frozen=$(echo $RESPONSE | jq -r '.checks.governance.kernelFrozen // false')" >> $GITHUB_OUTPUT
          echo "hash_valid=$(echo $RESPONSE | jq -r '.checks.governance.hashValid // false')" >> $GITHUB_OUTPUT
          echo "gov_ok=$(echo $RESPONSE | jq -r '.checks.governance.ok // false')" >> $GITHUB_OUTPUT
          echo "build_sha=$(echo $RESPONSE | jq -r '.checks.build.sha // empty')" >> $GITHUB_OUTPUT
          echo "locked_tag=$(echo $RESPONSE | jq -r '.checks.build.lockedTag // empty')" >> $GITHUB_OUTPUT
          echo "error_codes=$(echo $RESPONSE | jq -c '.errorCodes // []')" >> $GITHUB_OUTPUT

      - name: Validate responses
        run: |
          if [ -z "${{ steps.build.outputs.commit }}" ] || [ -z "${{ steps.integrity.outputs.status }}" ]; then
            echo "::error::Failed to fetch build-info or integrity endpoints"
            exit 1
          fi
          echo "‚úÖ build-info: commit=${{ steps.build.outputs.commit }}"
          echo "‚úÖ integrity: status=${{ steps.integrity.outputs.status }}, phase=${{ steps.integrity.outputs.phase }}"

      - name: Build snapshot payload
        id: payload
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "phaseId": "${{ steps.integrity.outputs.phase }}",
            "commit": "${{ steps.build.outputs.commit }}",
            "tag": "${{ steps.integrity.outputs.locked_tag }}",
            "version": "${{ steps.integrity.outputs.version }}",
            "environment": "${{ steps.target.outputs.env }}",
            "integrity": {
              "status": "${{ steps.integrity.outputs.status }}",
              "governance": {
                "kernelFrozen": ${{ steps.integrity.outputs.kernel_frozen }},
                "hashValid": ${{ steps.integrity.outputs.hash_valid }},
                "ok": ${{ steps.integrity.outputs.gov_ok }}
              },
              "errorCodes": ${{ steps.integrity.outputs.error_codes }},
              "signature": "${{ steps.integrity.outputs.signature }}",
              "buildSha": "${{ steps.integrity.outputs.build_sha }}"
            },
            "buildInfo": {
              "shaResolved": ${{ steps.build.outputs.sha_resolved }},
              "branch": "${{ steps.build.outputs.branch }}"
            },
            "evidence": {
              "${{ steps.target.outputs.env }}Url": "${{ steps.target.outputs.url }}",
              "ciRunUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
          }
          EOF
          )
          echo "$PAYLOAD" > /tmp/snapshot.json
          cat /tmp/snapshot.json | jq .

      - name: Sign and POST snapshot (Phase 34.3 ‚Äî Replay Protected)
        env:
          OPS_PHASE_LEDGER_SECRET: ${{ secrets.OPS_PHASE_LEDGER_SECRET }}
        run: |
          if [ -z "$OPS_PHASE_LEDGER_SECRET" ]; then
            echo "::error::OPS_PHASE_LEDGER_SECRET not set in GitHub Actions secrets"
            exit 1
          fi

          BODY=$(cat /tmp/snapshot.json)

          # Generate timestamp (unix ms) and nonce (32 hex chars = 16 bytes)
          TS=$(date +%s%3N)
          NONCE=$(openssl rand -hex 16)

          # Build signature base: "timestamp.nonce.body"
          SIGNATURE_BASE="${TS}.${NONCE}.${BODY}"
          SIGNATURE=$(echo -n "$SIGNATURE_BASE" | openssl dgst -sha256 -hmac "$OPS_PHASE_LEDGER_SECRET" | awk '{print $NF}')

          echo "üìù Timestamp: $TS"
          echo "üìù Nonce: ${NONCE:0:16}..."
          echo "üìù Signature: ${SIGNATURE:0:16}..."

          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-OPS-SIGNATURE: $SIGNATURE" \
            -H "X-OPS-TIMESTAMP: $TS" \
            -H "X-OPS-NONCE: $NONCE" \
            -d "$BODY" \
            "https://www.apicoredata.com/api/ops/phase-ledger/upsert")

          echo "üì¨ Response: HTTP $HTTP_CODE"
          cat /tmp/response.json | jq .

          if [ "$HTTP_CODE" != "200" ]; then
            ERROR_CODE=$(cat /tmp/response.json | jq -r '.code // "UNKNOWN"')
            echo "::error::Snapshot write failed with HTTP $HTTP_CODE (code: $ERROR_CODE)"
            exit 1
          fi

          echo "‚úÖ Phase Ledger snapshot written successfully"
