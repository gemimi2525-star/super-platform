# สัญญาพฤติกรรมการโต้ตอบ v1.0

> Phase 7.3 — ตรึงพฤติกรรม (Behavioral Freeze)
> 
> เอกสารนี้กำหนด **กฎการโต้ตอบแบบกำหนดแน่นอน (Deterministic)** สำหรับ NEXUS Shell
> พฤติกรรมทั้งหมดถูกตรึงแล้ว — การเปลี่ยนแปลงต้องได้รับการอนุมัติจาก Governance

---

## 1. โมเดลการโฟกัส (Focus Model)

### แหล่งความจริง (Source of Truth)
- **โฟกัส = ระดับหน้าต่างเท่านั้น**
- ณ เวลาใดๆ: `focusedWindowId: string | null`
- `null` = โฟกัสเดสก์ท็อป (สถานะสงบ/calm state)

### การเปลี่ยนโฟกัส (Focus Transitions)

| การกระทำ | ผลลัพธ์ |
|----------|---------|
| คลิกหน้าต่าง | โฟกัสหน้าต่างนั้น |
| คลิกเดสก์ท็อป (พื้นที่ว่าง) | ยกเลิกโฟกัสทั้งหมด → สถานะสงบ |
| ย่อหน้าต่างที่โฟกัส | ยกเลิกโฟกัส (ถ้าเคยโฟกัส) |
| ปิดหน้าต่างที่โฟกัส | ยกเลิกโฟกัส → สถานะสงบ หรือโฟกัสหน้าต่างถัดไป |
| คืนค่าจาก Dock | โฟกัสหน้าต่างที่คืนค่า |

### การเชื่อมต่อ Header/Menu Bar
- Menu Bar อ่านโฟกัสจาก ORBIT WindowManager
- ไม่มีแอปควบคุม Header โดยตรง
- Context menu แสดงแอปที่โฟกัส (ถ้ามี)

---

## 2. แป้นพิมพ์ลัด (Keyboard Shortcuts)

### แป้นลัดที่ใช้งาน

| แป้น | เงื่อนไข | การกระทำ |
|------|----------|----------|
| `ESC` | มีหน้าต่างโฟกัส | ยกเลิกโฟกัสทั้งหมด → สถานะสงบ |
| `ESC` | ยกเลิกโฟกัสแล้ว | ไม่ทำอะไร |
| `Cmd/Ctrl+W` | มีหน้าต่างโฟกัส | ปิดหน้าต่างที่โฟกัส |
| `Cmd/Ctrl+M` | มีหน้าต่างโฟกัส | ย่อหน้าต่างที่โฟกัส |

### กฎความปลอดภัย
- **ข้ามถ้ากำลังพิมพ์**: ไม่ทำงานเมื่อเป้าหมายเป็น `<input>`, `<textarea>`, หรือ `contentEditable`
- **ระดับ Shell เท่านั้น**: แป้นลัดส่งผ่าน NEXUS ไม่ใช่ต่อแอป
- **ไม่ขัดแย้ง**: แอปไม่สามารถ override แป้นลัดระบบได้

---

## 3. วงจรชีวิตหน้าต่าง (Window Lifecycle)

### เปิด (Open)
```
openCapability(id):
  ถ้ามีหน้าต่างสำหรับ id อยู่แล้ว → โฟกัสหน้าต่างที่มีอยู่
  มิฉะนั้น → สร้างหน้าต่างใหม่, โฟกัส
```

### ย่อ (Minimize)
- หน้าต่างซ่อนจากเดสก์ท็อป
- Dock แสดงรายการที่ย่อ
- คืนค่าผ่าน Dock → โฟกัสหน้าต่าง

### ปิด (Close)
- หน้าต่างถูกทำลาย
- แอป = ไม่ทำงาน (ไม่มี background process)
- ตัวบ่งชี้การทำงานบน Dock ถูกลบ

### ขยายเต็ม/คืนค่า (Maximize/Restore)
- ขยายเต็ม = เต็มพื้นที่เดสก์ท็อป (ไม่ใช่ fullscreen ของ OS)
- คืนค่า = กลับไปที่ `preMaximizeBounds`
- สลับผ่านปุ่มบน title bar

---

## 4. ประตูบทบาท (Persona Gates)

### ลำดับชั้นบทบาท
```
guest < user < admin < owner
```

### กฎการมองเห็น
```typescript
if (!capability.requiredRole) return visible; // มองเห็นได้
return roleHasAccess(userRole, capability.requiredRole);
```

### ที่ใช้งาน
- ตัวเปิดแอปบน Dock
- ส่วนการตั้งค่า (ในอนาคต)

---

## 5. สัญญาที่ไม่เปลี่ยนแปลง (Immutable Contracts)

| สัญญา | คำอธิบาย |
|-------|----------|
| **โฟกัส** | แหล่งความจริงเดียวใน WindowManager |
| **แป้นพิมพ์** | Shell ดักจับก่อนแอป |
| **วงจรชีวิต** | หน้าต่างเดียวต่อแอป single-instance |
| **บทบาท** | การมองเห็นตามบทบาท ไม่มีทางลัด |

---

## ประวัติเวอร์ชัน

| เวอร์ชัน | วันที่ | การเปลี่ยนแปลง |
|----------|--------|----------------|
| 1.0 | 2026-02-04 | ตรึงครั้งแรก (Phase 7.3) |
