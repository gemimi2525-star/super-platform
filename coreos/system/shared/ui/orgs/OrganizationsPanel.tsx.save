
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Organizations Panel â€” Phase 27C.2
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * Full-parity organizations management panel with CRUD, search, badges,
 * step-up auth, and decision logging.
 *
 * Used by both legacy OrganizationsApp and System Hub OrganizationView.
 *
 * @module coreos/system/shared/ui/orgs/OrganizationsPanel
 * @version 1.0.0
 */

import React, { useState, useEffect, useCallback } from 'react';
import type { OrgRecord, OrgFormData } from '../../types';
import type { OrgsDataSource } from '../../datasources/orgs-datasource';
import { orgsApiDataSource } from '../../datasources/orgs-api';
import { orgsMockDataSource } from '../../datasources/orgs-mock';
import { useGovernedMutation } from '../../hooks/useGovernedMutation';
import { StatusBadge } from '../StatusBadge';
import { PlanBadge } from '../PlanBadge';
import { SearchInput } from '../SearchInput';
import { OrgModal } from './OrgModal';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STYLES (Moved to top for scope visibility)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const containerStyle: React.CSSProperties = {
    padding: 20,
    height: '100%',
    overflow: 'auto',
    // color set dynamically in render
};

const headerStyle: React.CSSProperties = {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
};

const thStyle: React.CSSProperties = {
    textAlign: 'left',
    padding: '10px 12px',
    fontSize: 11,
    fontWeight: 600,
    textTransform: 'uppercase',
    letterSpacing: '0.5px',
    // color set dynamically
    // borderBottom set dynamically
};

const tdStyle: React.CSSProperties = {
    padding: '10px 12px',
    fontSize: 13,
    // borderBottom set dynamically
};

const btnStyle: React.CSSProperties = {
    padding: '6px 14px',
    background: '#007AFF',
    color: '#fff',
    border: 'none',
    borderRadius: 6,
    cursor: 'pointer',
    fontSize: 13,
    fontWeight: 500,
};

const actionBtnStyle: React.CSSProperties = {
    padding: '4px 10px',
    // background set dynamically
    border: 'none',
    borderRadius: 4,
    cursor: 'pointer',
    fontSize: 12,
    // color set dynamically
    marginRight: 6,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export interface OrganizationsPanelProps {
    /** 'light' for legacy OS Shell, 'dark' for System Hub */
    variant?: 'light' | 'dark';
    /** Data source mode */
    dataSourceMode?: 'api' | 'mock';
    /** Compact mode (fewer columns) */
    compact?: boolean;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getDataSource(mode: 'api' | 'mock'): OrgsDataSource {
    return mode === 'api' ? orgsApiDataSource : orgsMockDataSource;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function OrganizationsPanel(
  { variant = 'light', dataSourceMode = 'api', compact = false }: OrganizationsPanelProps
) {
    const isDark = variant === 'dark';
    const ds = getDataSource(dataSourceMode);

    // State
    const [orgs, setOrgs] = useState<OrgRecord[]>([]);
    const [loading, setLoading] = useState(true);
    const [search, setSearch] = useState('');
    const filtered = orgs.filter((o) => {
      return o.name.toLowerCase().includes(search.toLowerCase());
    });
    const [modal, setModal] = useState<{ isOpen: boolean; mode: 'create' | 'edit'; orgId?: string }>({
        isOpen: false,
        mode: 'create',
    });
    const [editingOrg, setEditingOrg] = useState<OrgRecord | undefined>();
    const [loadError, setLoadError] = useState<string | null>(null);

    // Governance
    const { governedCreate, governedUpdate, governedDelete, log } = useGovernedMutation();

    // Load
    const loadOrgs = useCallback(async () => {
        setLoading(true);
        setLoadError(null);
        try {
            const data = await ds.list();
            setOrgs(data);
        } catch (error: any) {
            console.error('[OrgsPanel] Failed to load:', error);
            // UX Fix
            setLoadError(error.message || 'Failed to load organizations');
        } finally {
            setLoading(false);
        }
    }, [ds]);

    useEffect(() => {
        loadOrgs();
        log({ action: 'orgs.view', detail: 'Organizations panel viewed' });
    }, [loadOrgs, log]);

    // ... (filters/handlers unchanged)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    return (
        <div style={containerStyle}>
            {loadError && (
                <div style={{ marginBottom: 20 }}>
                    <div style={{
                        padding: 12,
                        borderRadius: 6,
                        background: isDark ? 'rgba(229, 57, 53, 0.1)' : '#ffebee',
                        border: isDark ? '1px solid rgba(229, 57, 53, 0.2)' : '1px solid #ef5350',
                        color: isDark ? '#ffcdd2' : '#c62828',
                        fontSize: 13,
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }}>
                        <span>âš ï¸ {loadError}</span>
                        <button
                            onClick={loadOrgs}
                            style={{
                                background: 'transparent',
                                border: isDark ? '1px solid rgba(255,255,255,0.2)' : '1px solid rgba(0,0,0,0.1)',
                                borderRadius: 4,
                                color: 'inherit',
                                padding: '4px 8px',
                                cursor: 'pointer',
                                fontSize: 12
                            }}
                        >
                            Retry
                        </button>
                    </div>
                </div>
            )}

            {/* Header */}
            <div style={headerStyle}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600 }}>
                        ğŸ¢ Organizations ({filtered.length})
                    </h3>
                    <SearchInput
                        value={search}
                        onChange={setSearch}
                        placeholder="Search by name, slug, domain..."
                        variant={variant}
                    />
                </div>
                <button style={btnStyle} onClick={() => setModal({ isOpen: true, mode: 'create' })}>
                    + Create Organization
                </button>
            </div>

            {/* Table */}
            {loading ? (
                <div style={{ textAlign: 'center', padding: 40, color: isDark ? '#888' : '#999' }}>
                    Loading organizations...
                </div>
            ) : loadError ? (
                <div style={{ textAlign: 'center', padding: 40, color: isDark ? '#e53935' : '#d32f2f' }}>
                    Unable to display organizations.
                </div>
            ) : filtered.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 40, color: isDark ? '#888' : '#999' }}>
                    {search ? 'No organizations match your search.' : 'No organizations found.'}
                </div>
            ) : (
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                        <tr>
                            <th style={thStyle}>Name</th>
                            {!compact && <th style={thStyle}>Slug</th>}
                            <th style={thStyle}>Plan</th>
                            {!compact && <th style={thStyle}>Domain</th>}
                            <th style={thStyle}>Status</th>
                            <th style={{ ...thStyle, textAlign: 'right' }}>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filtered.map(org => (
                            <tr
                                key={org.id}
                                style={{ transition: 'background 0.15s' }}
                                onMouseEnter={e => {
                                    (e.currentTarget as HTMLElement).style.background =
                                        isDark ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)';
                                }}
                                onMouseLeave={e => {
                                    (e.currentTarget as HTMLElement).style.background = 'transparent';
                                }}
                            >
                                <td style={tdStyle}>
                                    <div style={{ fontWeight: 500 }}>{org.name}</div>
                                    {compact && org.slug && (
                                        <div style={{ fontSize: 11, color: isDark ? '#888' : '#999', marginTop: 2 }}>
                                            {org.slug}
                                        </div>
                                    )}
                                </td>
                                {!compact && (
                                    <td style={{ ...tdStyle, color: isDark ? '#888' : '#999', fontSize: 12 }}>
                                        {org.slug || 'â€”'}
                                    </td>
                                )}
                                <td style={tdStyle}>
                                    <PlanBadge plan={org.plan} variant={variant} />
                                </td>
                                {!compact && (
                                    <td style={{ ...tdStyle, color: isDark ? '#888' : '#999', fontSize: 12 }}>
                                        {org.domain || 'â€”'}
                                    </td>
                                )}
                                <td style={tdStyle}>
                                    <StatusBadge status={org.status || 'active'} variant={variant} />
                                </td>
                                <td style={{ ...tdStyle, textAlign: 'right' }}>
                                    <button style={actionBtnStyle} onClick={() => openEdit(org)}>
                                        Edit
                                    </button>
                                    <button
                                        style={{ ...actionBtnStyle, color: '#e53935' }}
                                        onClick={() => handleDisable(org.id)}
                                    >
                                        Disable
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            )}

            {/* Modal */}
            <OrgModal
                isOpen={modal.isOpen}
                mode={modal.mode}
                initialData={editingOrg}
                onSave={modal.mode === 'create' ? handleCreate : handleUpdate}
                onCancel={() => {
                    setModal({ isOpen: false, mode: 'create' });
                    setEditingOrg(undefined);
                }}
                variant={variant}
            />
        </div>
    );
}
'use client';

/**
 * Organizations Panel â€” Phase 27C.2 (Hotfix: build unblock)
 *
 * Fixes:
 * - Removes stray "$" artifacts that break TS parsing
 * - Ensures `filtered` is defined
 * - Ensures modal state type is complete
 *
 * Note:
 * - CRUD calls use `(ds as any)` to avoid compile breaks if OrgsDataSource method names differ.
 */

import React, { useCallback, useEffect, useMemo, useState } from 'react';

import type { OrgRecord, OrgFormData } from '../../../../../types';
import type { OrgsDataSource } from '../../../datasources/orgs-datasource';

import { orgsApiDataSource } from '../../../datasources/orgs-api';
import { orgsMockDataSource } from '../../../datasources/orgs-mock';

import { useGovernedMutation } from '../../../hooks/useGovernedMutation';

import { StatusBadge } from '../StatusBadge';
import { PlanBadge } from '../PlanBadge';
import { SearchInput } from '../SearchInput';
import { OrgModal } from './OrgModal';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STYLES (kept inline to match existing file style; must compile)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const containerStyle: React.CSSProperties = {
  padding: 20,
  height: '100%',
  overflow: 'auto',
};

const headerStyle: React.CSSProperties = {
  display: 'flex',
  justifyContent: 'space-between',
  alignItems: 'center',
  marginBottom: 16,
  gap: 12,
};

const hStyle: React.CSSProperties = {
  margin: 0,
  fontSize: 16,
  fontWeight: 600,
};

const toolbarStyle: React.CSSProperties = {
  display: 'flex',
  alignItems: 'center',
  gap: 10,
  flexWrap: 'wrap',
};

const listStyle: React.CSSProperties = {
  display: 'flex',
  flexDirection: 'column',
  gap: 10,
  marginTop: 14,
};

const rowStyle: React.CSSProperties = {
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'space-between',
  gap: 12,
  padding: '12px 12px',
  borderRadius: 10,
};

const leftStyle: React.CSSProperties = {
  display: 'flex',
  flexDirection: 'column',
  gap: 4,
  minWidth: 0,
};

const nameStyle: React.CSSProperties = {
  fontSize: 14,
  fontWeight: 600,
  lineHeight: 1.2,
  whiteSpace: 'nowrap',
  overflow: 'hidden',
  textOverflow: 'ellipsis',
};

const metaStyle: React.CSSProperties = {
  fontSize: 12,
  opacity: 0.8,
  whiteSpace: 'nowrap',
  overflow: 'hidden',
  textOverflow: 'ellipsis',
};

const rightStyle: React.CSSProperties = {
  display: 'flex',
  alignItems: 'center',
  gap: 8,
  flexShrink: 0,
};

const btnStyle: React.CSSProperties = {
  padding: '6px 10px',
  borderRadius: 8,
  border: 'none',
  cursor: 'pointer',
  fontSize: 12,
  fontWeight: 600,
};

const subtleBtnStyle: React.CSSProperties = {
  ...btnStyle,
  background: 'transparent',
};

const primaryBtnStyle: React.CSSProperties = {
  ...btnStyle,
  background: '#007AFF',
  color: '#fff',
};

const dangerBtnStyle: React.CSSProperties = {
  ...btnStyle,
  background: 'rgba(229, 57, 53, 0.12)',
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export interface OrganizationsPanelProps {
  /** 'light' for legacy OS Shell, 'dark' for System Hub */
  variant?: 'light' | 'dark';
  /** Data source mode */
  dataSourceMode?: 'api' | 'mock';
  /** Compact mode (fewer columns) */
  compact?: boolean;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getDataSource(mode: 'api' | 'mock'): OrgsDataSource {
  return mode === 'api' ? orgsApiDataSource : orgsMockDataSource;
}

function normalize(s: string) {
  return (s || '').toLowerCase().trim();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COMPONENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function OrganizationsPanel({
  variant = 'light',
  dataSourceMode = 'api',
  compact = false,
}: OrganizationsPanelProps) {
  const isDark = variant === 'dark';
  const ds = getDataSource(dataSourceMode);

  // State
  const [orgs, setOrgs] = useState<OrgRecord[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [loadError, setLoadError] = useState<string | null>(null);

  const [modal, setModal] = useState<{
    isOpen: boolean;
    mode: 'create' | 'edit';
    orgId?: string;
  }>({
    isOpen: false,
    mode: 'create',
  });

  const [editingOrg, setEditingOrg] = useState<OrgRecord | undefined>(undefined);

  // Governance
  const { governedCreate, governedUpdate, governedDelete, log } = useGovernedMutation();

  // Derived
  const filtered = useMemo(() => {
    const q = normalize(search);
    if (!q) return orgs;
    return orgs.filter((o) => normalize((o as any)?.name).includes(q));
  }, [orgs, search]);

  // Theme-ish
  const bg = isDark ? '#0B0E14' : '#FFFFFF';
  const cardBg = isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)';
  const border = isDark ? '1px solid rgba(255,255,255,0.10)' : '1px solid rgba(0,0,0,0.08)';
  const text = isDark ? '#E6EAF2' : '#121826';
  const muted = isDark ? 'rgba(230,234,242,0.75)' : 'rgba(18,24,38,0.75)';

  // Load
  const loadOrgs = useCallback(async () => {
    setLoading(true);
    setLoadError(null);
    try {
      const data = await (ds as any).list();
      setOrgs(Array.isArray(data) ? data : []);
    } catch (error: any) {
      console.error('[OrgsPanel] Failed to load:', error);
      setLoadError(error?.message || 'Failed to load organizations');
    } finally {
      setLoading(false);
    }
  }, [ds]);

  useEffect(() => {
    loadOrgs();
    log({ action: 'orgs.view', detail: 'Organizations panel viewed' });
  }, [loadOrgs, log]);

  // Actions
  const openCreate = useCallback(() => {
    setEditingOrg(undefined);
    setModal({ isOpen: true, mode: 'create' });
  }, []);

  const openEdit = useCallback((org: OrgRecord) => {
    setEditingOrg(org);
    setModal({ isOpen: true, mode: 'edit', orgId: (org as any)?.id });
  }, []);

  const closeModal = useCallback(() => {
    setModal((m) => ({ ...m, isOpen: false }));
    setEditingOrg(undefined);
  }, []);

  const onSubmit = useCallback(
    async (form: OrgFormData) => {
      // NOTE: keep compile-safe even if ds method names differ
      const dsAny = ds as any;

      if (modal.mode === 'create') {
        await governedCreate(async () => {
          if (typeof dsAny.create === 'function') return dsAny.create(form);
          if (typeof dsAny.insert === 'function') return dsAny.insert(form);
          // fallback: no-op (still refresh list)
          return null;
        }, { action: 'orgs.create', detail: 'Create organization' });
      } else {
        const orgId = modal.orgId || (editingOrg as any)?.id;
        await governedUpdate(async () => {
          if (typeof dsAny.update === 'function') return dsAny.update(orgId, form);
          if (typeof dsAny.edit === 'function') return dsAny.edit(orgId, form);
          return null;
        }, { action: 'orgs.update', detail: `Update organization ${orgId || ''}` });
      }

      closeModal();
      await loadOrgs();
    },
    [ds, modal.mode, modal.orgId, editingOrg, governedCreate, governedUpdate, closeModal, loadOrgs]
  );

  const onDelete = useCallback(
    async (org: OrgRecord) => {
      const dsAny = ds as any;
      const orgId = (org as any)?.id;

      await governedDelete(async () => {
        if (typeof dsAny.remove === 'function') return dsAny.remove(orgId);
        if (typeof dsAny.delete === 'function') return dsAny.delete(orgId);
        return null;
      }, { action: 'orgs.delete', detail: `Delete organization ${orgId || ''}` });

      await loadOrgs();
    },
    [ds, governedDelete, loadOrgs]
  );

  return (
    <div style={{ ...containerStyle, background: bg, color: text }}>
      <div style={headerStyle}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12, minWidth: 0 }}>
          <h3 style={hStyle}>ğŸ¢ Organizations ({filtered.length})</h3>
          <StatusBadge status={loading ? 'loading' : loadError ? 'error' : 'ok'} />
          <PlanBadge label={dataSourceMode === 'mock' ? 'MOCK' : 'API'} />
        </div>

        <div style={toolbarStyle}>
          <SearchInput value={search} onChange={setSearch} placeholder="Search organizations..." />
          <button style={primaryBtnStyle} onClick={openCreate}>
            + New
          </button>
        </div>
      </div>

      {loadError ? (
        <div
          style={{
            padding: 12,
            borderRadius: 10,
            border: isDark ? '1px solid rgba(239,83,80,0.35)' : '1px solid rgba(229,57,53,0.35)',
            background: isDark ? 'rgba(229,57,53,0.10)' : 'rgba(229,57,53,0.06)',
            color: text,
          }}
        >
          <div style={{ fontWeight: 700, marginBottom: 6 }}>Load error</div>
          <div style={{ color: muted }}>{loadError}</div>
          <div style={{ marginTop: 10 }}>
            <button style={btnStyle} onClick={loadOrgs}>
              Retry
            </button>
          </div>
        </div>
      ) : null}

      <div style={listStyle}>
        {loading ? (
          <div style={{ color: muted }}>Loading...</div>
        ) : filtered.length === 0 ? (
          <div style={{ color: muted }}>No organizations found.</div>
        ) : (
          filtered.map((org) => {
            const id = (org as any)?.id;
            const name = (org as any)?.name ?? '(no name)';
            const slug = (org as any)?.slug;
            const createdAt = (org as any)?.createdAt;

            return (
              <div
                key={id || name}
                style={{
                  ...rowStyle,
                  background: cardBg,
                  border,
                }}
              >
                <div style={leftStyle}>
                  <div style={nameStyle} title={String(name)}>
                    {String(name)}
                  </div>
                  <div style={metaStyle}>
                    {slug ? `slug: ${slug}` : null}
                    {slug && createdAt ? ' â€¢ ' : null}
                    {createdAt ? `created: ${String(createdAt)}` : null}
                  </div>
                </div>

                <div style={rightStyle}>
                  <button
                    style={{ ...subtleBtnStyle, color: text, border }}
                    onClick={() => openEdit(org)}
                    title="Edit"
                  >
                    Edit
                  </button>
                  <button
                    style={{ ...dangerBtnStyle, color: text, border: isDark ? '1px solid rgba(239,83,80,0.35)' : '1px solid rgba(229,57,53,0.35)' }}
                    onClick={() => onDelete(org)}
                    title="Delete"
                  >
                    Delete
                  </button>
                </div>
              </div>
            );
          })
        )}
      </div>

      <OrgModal
        isOpen={modal.isOpen}
        mode={modal.mode}
        org={editingOrg}
        compact={compact}
        onClose={closeModal}
        onSubmit={onSubmit}
      />
    </div>
  );
}

export default OrganizationsPanel;
