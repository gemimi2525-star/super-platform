# Audit Event Schema Design

**Version:** 1.0  
**Date:** 2026-01-22  
**Phase:** 10.2  
**Status:** DESIGN DOCUMENT (Single Source of Truth)

---

## üéØ Objective

‡∏ô‡∏¥‡∏¢‡∏≤‡∏° **Unified Audit Event Schema** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Super Platform:
- ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å module
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö success ‡πÅ‡∏•‡∏∞ denial events
- ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö persistence ‡πÅ‡∏•‡∏∞ query

---

## üõ°Ô∏è Design Principles

1. **Append-only** - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö audit records
2. **Server timestamps** - ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å server ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
3. **PII minimal** - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
4. **Single schema** - event ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ä‡πâ schema ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
5. **Extensible** - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï

---

## üì¶ Canonical Audit Event Schema

### Required Fields (‡∏ó‡∏∏‡∏Å event ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ)

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Auto-generated document ID |
| `eventType` | string | Event category (see taxonomy) |
| `action` | string | Specific action name |
| `timestamp` | Date | Server timestamp (Firestore FieldValue) |
| `actor.uid` | string | UID of user performing action |
| `actor.email` | string | Email of actor (for readability) |
| `actor.role` | string | Role at time of action |
| `success` | boolean | Whether action succeeded |

### Optional Fields (‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó event)

| Field | Type | When Used | Description |
|-------|------|-----------|-------------|
| `target.uid` | string | User operations | Target user's UID |
| `target.email` | string | User operations | Target user's email |
| `target.id` | string | Entity operations | Target entity ID |
| `target.type` | string | Entity operations | Entity type (org/role) |
| `target.name` | string | Entity operations | Entity name |
| `requiredRole` | string | Permission denial | Role required for action |
| `actualRole` | string | Permission denial | Actor's actual role |
| `requiredPermission` | string | Permission denial | Permission required |
| `details` | object | Any | Additional metadata |
| `method` | string | API operations | HTTP method |
| `path` | string | API operations | API endpoint path |
| `ipAddress` | string | Security audit | Client IP (optional) |
| `userAgent` | string | Security audit | Browser/client info |
| `errorCode` | string | Failures | Error code if failed |
| `errorMessage` | string | Failures | Error message if failed |

### Prohibited Fields (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡πá‡∏ö)

- Passwords ‡∏´‡∏£‡∏∑‡∏≠ credentials
- Full request/response bodies
- PII ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (address, phone)
- Financial data
- Medical data

---

## üè∑Ô∏è Event Taxonomy

### 1. Permission Events

| eventType | action | Description |
|-----------|--------|-------------|
| `permission` | `denied` | Permission check failed (403) |
| `permission` | `granted` | Permission check passed (optional) |

### 2. Organization Events

| eventType | action | Description |
|-----------|--------|-------------|
| `org` | `created` | Organization created |
| `org` | `updated` | Organization updated |
| `org` | `deleted` | Organization deleted/disabled |
| `org` | `viewed` | Organization detail viewed (optional) |

### 3. User Events

| eventType | action | Description |
|-----------|--------|-------------|
| `user` | `created` | User created |
| `user` | `updated` | User updated |
| `user` | `deleted` | User deleted |
| `user` | `disabled` | User disabled |
| `user` | `enabled` | User enabled |

### 4. Role Events

| eventType | action | Description |
|-----------|--------|-------------|
| `role` | `created` | Role created |
| `role` | `updated` | Role updated |
| `role` | `deleted` | Role deleted |
| `role` | `copied` | Role copied |

### 5. Auth Events (Optional)

| eventType | action | Description |
|-----------|--------|-------------|
| `auth` | `login.success` | Successful login |
| `auth` | `login.failed` | Failed login attempt |
| `auth` | `logout` | User logged out |

---

## üë§ Actor & Entity Model

### Actor

```typescript
interface AuditActor {
    uid: string;      // Firebase UID
    email: string;    // User email
    role: PlatformRole; // Role at time of action
}
```

- Actor = ‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≥ action
- ‡πÄ‡∏Å‡πá‡∏ö role ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥ (snapshot)

### Target

```typescript
interface AuditTarget {
    // For user targets
    uid?: string;
    email?: string;
    
    // For entity targets (org, role)
    id?: string;
    type?: 'org' | 'role' | 'user';
    name?: string;
}
```

---

## üóÑÔ∏è Firestore Collection Design

### Collection Name
`platform_audit_logs`

### Document ID
- Auto-generated by Firestore
- ‡∏´‡∏£‡∏∑‡∏≠: `{timestamp}_{eventType}_{action}_{randomId}`

### Example Document

```json
{
  "id": "auto-generated",
  "eventType": "user",
  "action": "created",
  "timestamp": "2026-01-22T14:30:00.000Z",
  "actor": {
    "uid": "abc123",
    "email": "admin@example.com",
    "role": "admin"
  },
  "target": {
    "uid": "xyz789",
    "email": "newuser@example.com",
    "type": "user"
  },
  "success": true,
  "details": {
    "assignedRole": "user"
  }
}
```

### Permission Denied Example

```json
{
  "eventType": "permission",
  "action": "denied",
  "timestamp": "2026-01-22T14:31:00.000Z",
  "actor": {
    "uid": "user456",
    "email": "user@example.com",
    "role": "user"
  },
  "success": false,
  "requiredRole": "owner",
  "actualRole": "user",
  "method": "DELETE",
  "path": "/api/platform/users/abc123",
  "details": {
    "guard": "requireOwner"
  }
}
```

### Recommended Indexes

| Fields | Purpose |
|--------|---------|
| `eventType`, `timestamp desc` | Filter by event type |
| `actor.uid`, `timestamp desc` | Filter by actor |
| `target.uid`, `timestamp desc` | Filter by target |
| `success`, `timestamp desc` | Filter failures |

---

## üîÑ Backward Compatibility

### Existing Schema (Current)

```typescript
// Success events (in DB)
{
    action: 'user.created',
    actorUid: string,
    actorEmail: string,
    targetUid?: string,
    targetEmail?: string,
    details: object,
    timestamp: Date
}

// Denial events (console only)
{
    event: 'permission.denied',
    requiredRole: string,
    actualRole: string,
    userId: string,
    method: string,
    path: string,
    action: string,
    timestamp: string
}
```

### Migration Rules

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `action` (e.g., "user.created") | `eventType` + `action` | Split into category + action |
| `actorUid` | `actor.uid` | Nested object |
| `actorEmail` | `actor.email` | Nested object |
| `targetUid` | `target.uid` | Nested object |
| `targetEmail` | `target.email` | Nested object |
| `details` | `details` | Keep as-is |
| `timestamp` | `timestamp` | Keep as-is |
| `event` | `eventType` | Rename |
| `userId` | `actor.uid` | Map |

### Compatibility Approach

1. **New writes:** Use new schema
2. **Old reads:** Handle both formats in read API
3. **No migration:** Keep old records as-is, handle in code

---

## üìã TypeScript Interface (Reference)

```typescript
interface AuditEvent {
    id?: string;
    eventType: 'permission' | 'org' | 'user' | 'role' | 'auth';
    action: string;
    timestamp: Date;
    actor: {
        uid: string;
        email: string;
        role: PlatformRole;
    };
    target?: {
        uid?: string;
        email?: string;
        id?: string;
        type?: string;
        name?: string;
    };
    success: boolean;
    requiredRole?: string;
    actualRole?: string;
    requiredPermission?: string;
    method?: string;
    path?: string;
    details?: Record<string, unknown>;
    ipAddress?: string;
    userAgent?: string;
    errorCode?: string;
    errorMessage?: string;
}
```

---

## ‚úÖ Schema Lock

This schema is **LOCKED** for Phase 10.

---

## ‚ñ∂Ô∏è Next Step

**Phase 10.3 ‚Äî Centralized Emit Helper (Plan)**
