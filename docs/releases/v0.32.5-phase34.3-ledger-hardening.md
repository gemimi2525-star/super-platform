# Phase 34.3 — CI Ledger Hardening (Direct Firestore Write-back)

**Version**: v0.32.5  
**Date**: 2026-02-17  
**Phase**: 34.3  

---

## Summary

Fixed CI workflow `phase-ledger-write.yml` which was blocked by Vercel Bot Protection (HTTP 429).  
Replaced all 3 production HTTP calls (`curl`) with a direct Firestore write using `firebase-admin` SDK.

This eliminates dependency on production endpoint availability for CI write-back, making the pipeline
resilient against WAF/bot-protection changes.

---

## Commits

| Commit | Description |
|--------|-------------|
| `15f409c` | Rewrite CI: remove 3 curl calls, add Node.js + firebase-admin for direct Firestore write |
| `07216a6` | Adapt to individual Firebase secrets (FIREBASE_PROJECT_ID, FIREBASE_CLIENT_EMAIL, FIREBASE_PRIVATE_KEY) |

## CI Run

- **Workflow**: Phase Ledger Write — Phase 34.3, Run #5  
- **URL**: https://github.com/gemimi2525-star/super-platform/actions/runs/22092769721  
- **Duration**: 4m 3s  
- **Status**: ✅ Success  

## Firestore Document

- **Collection**: `coreos_phase_ledger`  
- **Doc ID**: `34_production_07216a6`  
- **Source**: `github-actions-direct-firestore`  
- **Created**: 2026-02-17T09:31:07Z  

---

## DoD — 6 Layer Checklist

| Layer | Gate | Status | Evidence |
|-------|------|--------|----------|
| L0 | Local tests | ✅ | `pnpm -s tsc --noEmit` clean |
| L1 | Browser subagent local | ✅ | Verified CI logs, Firestore doc, Ops Center via browser |
| L2 | Firebase check | ✅ | Doc `34_production_07216a6` exists in `coreos_phase_ledger` |
| L3 | Preview | N/A | Docs-only change after CI fix; no preview deploy needed |
| L4 | Production | ✅ | `/ops` shows Parity Baseline Phase 34 OK, ledger 1 entries ✓ |
| L5 | CI write-back | ✅ | Run #5 PASS, Firestore write confirmed in logs |

---

## Evidence Pack — Production API Responses

### `/api/build-info`

```json
{
  "commit": "07216a6eaf21fbb7d56494746ac3abcf017077f8",
  "branch": "main",
  "buildTime": "2026-02-17T09:38:15.476Z",
  "environment": "production",
  "version": "0.32.5",
  "shaResolved": true
}
```

### `/api/platform/integrity`

```json
{
  "status": "OK",
  "checks": {
    "firebase": {
      "ok": true,
      "latencyMs": 519,
      "mode": "firestore"
    },
    "auth": {
      "mode": "REAL",
      "ok": true
    },
    "governance": {
      "kernelFrozen": true,
      "hashValid": true,
      "ok": true
    },
    "build": {
      "sha": "07216a6",
      "lockedTag": "v0.32.5",
      "ok": true
    }
  },
  "errorCodes": [],
  "ts": "2026-02-17T09:44:03.300Z",
  "phase": "34",
  "version": "v0.32.5",
  "signature": "a82654ecaf7242d14faea884da38901d5f5528d28d7d1363e6a6142198a22aa8"
}
```

### Firestore Snapshot (from CI logs)

```json
{
  "phaseId": "34",
  "commit": "07216a6eaf21fbb7d56494746ac3abcf01707f8",
  "commitShort": "07216a6",
  "tag": "v0.32.5",
  "version": "v0.32.5",
  "environment": "production",
  "integrity": {
    "status": "OK",
    "governance": {
      "kernelFrozen": true,
      "hashValid": true,
      "ok": true
    },
    "errorCodes": [],
    "signature": null,
    "buildSha": "07216a6"
  },
  "buildInfo": {
    "shaResolved": true,
    "branch": "main"
  },
  "evidence": {
    "ciRunUrl": "https://github.com/gemimi2525-star/super-platform/actions/runs/22092769721",
    "productionUrl": "https://www.apicoredata.com",
    "source": "github-actions-direct-firestore"
  },
  "createdAt": "[SERVER_TIMESTAMP]"
}
```

---

## Screenshots

1. CI Workflow Success — `ci_workflow_success_1771320910720.png`
2. CI Logs (Doc ID + write success) — `ci_logs_firestore_write_1771320929080.png`
3. Firestore Document — `firestore_doc_evidence_1771320950218.png`
4. Ops Center — `ops_center_evidence_1771320986795.png`
5. build-info API — `build_info_prod_1771321436239.png`
6. integrity API — `integrity_prod_1771321453641.png`
7. Manual Run #7 Logs — `manual_run7_logs_1771322543854.png`
8. Firestore doc c61f38e — `firestore_c61f38e_1771322561361.png`
9. Ops Center updated — `ops_ledger_updated_1771322582456.png`

---

## Ledger Parity Verification (commit `c61f38e`)

Docs commit `c61f38e` auto-triggered CI Run #6 (4m 6s ✅) and was also verified via
manual dispatch Run #7 (1m 52s ✅).

- **Firestore**: `coreos_phase_ledger/34_production_c61f38e` — created 2026-02-17T10:00:43Z
- **Ops Center**: Parity Baseline updated to commit `c61f38e`, ledger `1 entries ✓` → OK
- **Conclusion**: Workflow correctly triggers for ALL main pushes (including docs commits)

---

## Policy

> **Ledger snapshot is written for every production deploy commit on main to maintain parity
> with `/ops` baseline.** No `paths-ignore` filter is used — all pushes trigger the CI
> write-back workflow to ensure the ledger always reflects the current production state.

---

## Known Issues (Separate Phase)

- `/ops` → "History (Search Phases)" returns **HTTP 500** — to be addressed in a separate Phase.
